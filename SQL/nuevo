-- 1. Configuraciones iniciales
SET client_encoding = 'UTF8';
SET standard_conforming_strings = 'on';
SELECT pg_catalog.set_config('search_path', '', false);

-- 2. Creación de la base de datos (opcional)
-- DROP DATABASE IF EXISTS pry_lectura;
-- CREATE DATABASE pry_lectura WITH TEMPLATE = template0 ENCODING = 'UTF8' LOCALE_PROVIDER = libc LOCALE = 'Spanish_Ecuador.1252';
-- \c pry_lectura;

-- 3. Tablas, secuencias y PK
--------------------------------------------------------------------------------
-- roles
CREATE SEQUENCE public.roles_id_seq AS integer START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1;
CREATE TABLE public.roles (
    id integer NOT NULL DEFAULT nextval('public.roles_id_seq'::regclass),
    nombre varchar(50) NOT NULL
);
ALTER SEQUENCE public.roles_id_seq OWNED BY public.roles.id;
ALTER TABLE ONLY public.roles ADD CONSTRAINT roles_pkey PRIMARY KEY (id);
ALTER TABLE ONLY public.roles ADD CONSTRAINT roles_nombre_key UNIQUE (nombre);

-- usuarios
CREATE SEQUENCE public.usuarios_id_seq AS integer START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1;
CREATE TABLE public.usuarios (
    id integer NOT NULL DEFAULT nextval('public.usuarios_id_seq'::regclass),
    nombre text NOT NULL,
    apellido text NOT NULL,
    correo text NOT NULL,
    contrasena text NOT NULL,
    rol_id integer,
    creado_en timestamp without time zone DEFAULT now(),
    ultimo_acceso timestamp without time zone
);
ALTER SEQUENCE public.usuarios_id_seq OWNED BY public.usuarios.id;
ALTER TABLE ONLY public.usuarios ADD CONSTRAINT usuarios_pkey PRIMARY KEY (id);
ALTER TABLE ONLY public.usuarios ADD CONSTRAINT usuarios_correo_key UNIQUE (correo);

-- sesiones (flujo continuo)
CREATE SEQUENCE public.sesiones_id_seq AS integer START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1;
CREATE TABLE public.sesiones (
    id integer NOT NULL DEFAULT nextval('public.sesiones_id_seq'::regclass),
    usuario_id integer,
    fecha_inicio timestamp without time zone DEFAULT now(),
    fecha_fin timestamp without time zone,
    tipo_actividad varchar(20),          -- 'pdf' | 'video'
    fuente varchar(255),                 -- nombre del PDF o título del video
    total_segundos integer,
    alertas integer DEFAULT 0,
    kss_final integer,
    es_fatiga boolean,
    resumen jsonb,                       -- {fatiga_acumulada, momentos, recomendaciones}
    actividades_completadas boolean DEFAULT false
);
ALTER SEQUENCE public.sesiones_id_seq OWNED BY public.sesiones.id;
ALTER TABLE ONLY public.sesiones ADD CONSTRAINT sesiones_pkey PRIMARY KEY (id);

-- mediciones (sin etapa inicial/final, métricas continuas)
CREATE SEQUENCE public.mediciones_id_seq AS integer START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1;
CREATE TABLE public.mediciones (
    id integer NOT NULL DEFAULT nextval('public.mediciones_id_seq'::regclass),
    sesion_id integer,
    actividad varchar(20),               -- 'pdf' | 'video'
    perclos numeric(5,2),
    parpadeos integer,
    blink_rate_min numeric(6,2),
    ear_promedio numeric(10,4),
    pct_incompletos numeric(5,2),
    tiempo_cierre numeric(6,2),
    num_bostezos integer,
    velocidad_ocular numeric(10,4),
    nivel_subjetivo integer,
    nivel_fatiga integer,
    estado_fatiga varchar(50),
    max_sin_parpadeo integer,            -- segundos
    alertas integer,
    momentos_fatiga jsonb,               -- [{t,reason}]
    fecha timestamp without time zone DEFAULT now()
);
ALTER SEQUENCE public.mediciones_id_seq OWNED BY public.mediciones.id;
ALTER TABLE ONLY public.mediciones ADD CONSTRAINT mediciones_pkey PRIMARY KEY (id);

-- alertas puntuales (opcional pero útil para historial)
CREATE TABLE IF NOT EXISTS public.alertas (
    id serial PRIMARY KEY,
    sesion_id integer REFERENCES public.sesiones(id) ON DELETE CASCADE,
    momento_seg integer,
    motivo text,
    creada_en timestamp without time zone DEFAULT now()
);

-- diagnosticos_ia (se mantiene)
CREATE SEQUENCE public.diagnosticos_ia_id_seq AS integer START WITH 1 INCREMENT BY 1 NO MINVALUE NO MAXVALUE CACHE 1;
CREATE TABLE public.diagnosticos_ia (
    id integer NOT NULL DEFAULT nextval('public.diagnosticos_ia_id_seq'::regclass),
    sesion_id integer NOT NULL,
    diagnostico_json jsonb NOT NULL,
    fecha_creacion timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);
ALTER SEQUENCE public.diagnosticos_ia_id_seq OWNED BY public.diagnosticos_ia.id;
ALTER TABLE ONLY public.diagnosticos_ia ADD CONSTRAINT diagnosticos_ia_pkey PRIMARY KEY (id);
ALTER TABLE ONLY public.diagnosticos_ia ADD CONSTRAINT diagnosticos_ia_sesion_id_key UNIQUE (sesion_id);

-- 4. Foreign keys
--------------------------------------------------------------------------------
ALTER TABLE ONLY public.usuarios
    ADD CONSTRAINT usuarios_rol_id_fkey FOREIGN KEY (rol_id) REFERENCES public.roles(id);

ALTER TABLE ONLY public.sesiones
    ADD CONSTRAINT sesiones_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.usuarios(id) ON DELETE CASCADE;

ALTER TABLE ONLY public.mediciones
    ADD CONSTRAINT mediciones_sesion_id_fkey FOREIGN KEY (sesion_id) REFERENCES public.sesiones(id) ON DELETE CASCADE;

ALTER TABLE ONLY public.diagnosticos_ia
    ADD CONSTRAINT diagnosticos_ia_sesion_id_fkey FOREIGN KEY (sesion_id) REFERENCES public.sesiones(id) ON DELETE CASCADE;

-- 5. Datos iniciales
--------------------------------------------------------------------------------
INSERT INTO public.roles (id, nombre) VALUES (1, 'Administrador'), (2, 'Usuario')
ON CONFLICT DO NOTHING;
SELECT pg_catalog.setval('public.roles_id_seq', 2, true);

INSERT INTO public.usuarios (nombre, apellido, correo, contrasena, rol_id)
VALUES ('Admin', 'Principal', 'admin@admin.com', '$2b$12$5ymgdz8lADZMrCAjp68b4eBr8EAt2tVP4U0hzeqrYTQ2cu/h4rSt2', 1)
ON CONFLICT (correo) DO NOTHING;
SELECT pg_catalog.setval('public.usuarios_id_seq', 1, true);

-- 6. Índices recomendados
--------------------------------------------------------------------------------
CREATE INDEX IF NOT EXISTS idx_sesiones_usuario ON public.sesiones(usuario_id);
CREATE INDEX IF NOT EXISTS idx_mediciones_sesion ON public.mediciones(sesion_id);
CREATE INDEX IF NOT EXISTS idx_alertas_sesion ON public.alertas(sesion_id);