<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Fatiga - SecurityEye</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/auth_shared.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .metric-card {
            background: rgba(58, 125, 142, 0.1);
            border: 1px solid rgba(58, 125, 142, 0.3);
            border-radius: 8px;
        }
        #contentContainer {
            background: #1a1a1a;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="page-bg"></div>
    
    <script src="/static/js/session.js"></script>
    <script>protegerRuta('usuario');</script>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-global">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="/usuario/index.html">
                <i class="bi bi-eye"></i> SecurityEye
            </a>
            <span class="navbar-text ms-auto">
                <small class="text-muted">Monitoreo continuo</small>
            </span>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid px-4 py-4">
        
        <!-- Información de sesión -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i>
                    <strong>Sesión:</strong> <span id="sessionInfo">Cargando...</span>
                </div>
            </div>
        </div>

        <!-- Layout principal: Cámara/Métricas | Contenido -->
        <div class="row g-3">
            
            <!-- COLUMNA IZQUIERDA: Cámara + Métricas + Controles (20%) -->
            <div class="col-lg-3">
                
                <!-- Área de cámara -->
                <div class="card-gradient p-2 mb-3">
                    <h6 class="fw-bold mb-2 small">Monitoreo Visual</h6>
                    <div class="video-container" style="height: 250px;">
                        <video id="videoElement" playsinline autoplay muted class="d-none"></video>
                        <canvas id="output_canvas" width="640" height="480" 
                                style="width:100%; height:100%; object-fit:contain;"></canvas>
                        <div id="statusOverlay" class="position-absolute top-50 start-50 translate-middle text-center text-white">
                            <i class="bi bi-camera-video fs-1 d-block mb-2"></i>
                            <p id="statusText">Esperando cámara...</p>
                        </div>
                    </div>
                </div>

                <!-- Banner de alerta -->
                <div id="alertBanner" class="alert alert-warning alert-dismissible fade d-none mb-3" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span id="alertText"> Fatiga detectada</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Métricas en tarjetas -->
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <div class="metric-card p-2 text-center">
                            <small class="text-muted d-block" style="font-size: 0.7rem;">PARPADEOS</small>
                            <h5 id="blinkCount" class="mb-0 fw-bold">0</h5>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card p-2 text-center">
                            <small class="text-muted d-block" style="font-size: 0.7rem;">BOSTEZOS</small>
                            <h5 id="yawnCount" class="mb-0 fw-bold">0</h5>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="metric-card p-2 text-center">
                            <small class="text-muted d-block" style="font-size: 0.7rem;">TIEMPO</small>
                            <h5 id="timerCount" class="mb-0 fw-bold">00:00</h5>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="metric-card p-2 text-center">
                            <small class="text-muted d-block" style="font-size: 0.7rem;">PERCLOS (%)</small>
                            <h5 id="perclosDisplay" class="mb-0 fw-bold">--</h5>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="metric-card p-2 text-center" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.4);">
                            <small class="text-muted d-block" style="font-size: 0.7rem;">ALERTAS</small>
                            <h5 id="alertsCount" class="mb-0 fw-bold text-warning">0</h5>
                        </div>
                    </div>
                </div>

                <!-- Botones de control -->
                <div class="d-grid gap-2 mb-2">
                    <button id="startBtn" class="btn btn-success fw-bold">
                        <i class="bi bi-camera-video"></i> Iniciar
                    </button>
                    <button id="endSessionBtn" class="btn btn-danger btn-sm fw-bold" disabled>
                        <i class="bi bi-stop-circle"></i> Finalizar
                    </button>
                </div>

                <!-- Actividades de descanso -->
                <div class="card-gradient p-2">
                    <h6 class="fw-bold mb-2 small">Descanso</h6>
                    <div class="d-grid gap-1">
                        <button id="breakBtn1" class="btn btn-sm btn-outline-info">20-20-20</button>
                        <button id="breakBtn2" class="btn btn-sm btn-outline-info">Ejercicio</button>
                        <button id="breakBtn3" class="btn btn-sm btn-outline-info">5 min</button>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: Contenido (Video/PDF) (80%) -->
            <div class="col-lg-9">
                <div class="card-gradient p-3" style="height: 100%;">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-file-earmark-play"></i> Contenido
                    </h5>
                    <div id="contentContainer" 
                         style="width:100%; height:calc(100% - 50px); min-height:700px; overflow:auto; display:flex; align-items:center; justify-content:center;">
                        <p class="text-white text-center m-0">
                            <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                            <span class="opacity-50">El contenido se cargará aquí</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal KSS -->
    <div class="modal fade" id="subjectiveModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Escala de Somnolencia (KSS)</h5>
                </div>
                <div class="modal-body">
                    <p class="text-center mb-4">¿Qué tan somnoliento te sientes en este momento?</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-secondary kss-btn" data-kss="3">3 - Alerta</button>
                        <button class="btn btn-outline-secondary kss-btn" data-kss="5">5 - Medio</button>
                        <button class="btn btn-outline-secondary kss-btn" data-kss="7">7 - Somnoliento</button>
                        <button class="btn btn-outline-secondary kss-btn" data-kss="9">9 - Muy somnoliento</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Resumen -->
    <div class="modal fade" id="summaryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Resumen de sesión</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <small class="text-muted d-block">Tiempo total</small>
                            <h4 id="sumTotalTime">--</h4>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Alertas</small>
                            <h4 id="sumAlerts">--</h4>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">PERCLOS</small>
                            <h4 id="sumPerclos">--%</h4>
                        </div>
                    </div>
                    <div id="summaryContent"></div>
                    <p class="text-center mt-4 text-muted small">Ver detalles completos en tu historial.</p>
                </div>
                <div class="modal-footer">
                    <a href="/usuario/index.html" class="btn btn-primary">Volver al panel</a>
                    <a href="/usuario/historial.html" class="btn btn-outline-secondary">Ver historial</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Actividades de Descanso -->
    <div class="modal fade" id="breakActivityModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-heart-pulse"></i> Actividades de descanso
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Selecciona una actividad para reducir la fatiga:</p>
                    <div id="breakActivitiesContainer" class="d-grid gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
    <script src="/static/js/monitoreo.js"></script>
</body>
</html>
